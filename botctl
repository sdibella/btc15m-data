#!/usr/bin/env bash
# Bot control script for KXBTC15M Data Collector (systemd)

set -e

BOT_DIR="$(cd "$(dirname "$0")" && pwd)"
BOT_BIN="$BOT_DIR/datacollector"
SERVICE="datacollector.service"

cd "$BOT_DIR"

usage() {
    cat <<EOF
Usage: ./botctl <command>

Commands:
    start        Build + start the data collector
    stop         Graceful shutdown
    restart      Stop + rebuild + start
    status       Show running status + stats
    logs         Follow journal logs
    build        Build the binary

Examples:
    ./botctl start                    # Build + start collector
    ./botctl status                   # Check status
    ./botctl logs                     # Watch logs
    ./botctl stop                     # Graceful shutdown

EOF
}

build() {
    echo "Building datacollector..."
    go build -o "$BOT_BIN" ./cmd/datacollector
    echo "Build complete: $BOT_BIN"
}

start() {
    build
    systemctl --user start "$SERVICE"
    sleep 1
    systemctl --user status "$SERVICE" --no-pager
}

stop() {
    systemctl --user stop "$SERVICE"
    echo "Collector stopped"
}

restart() {
    systemctl --user stop "$SERVICE" 2>/dev/null || true
    build
    systemctl --user start "$SERVICE"
    sleep 1
    systemctl --user status "$SERVICE" --no-pager
}

status() {
    echo "Data Collector Status:"
    echo ""

    systemctl --user status "$SERVICE" --no-pager 2>/dev/null || true

    echo ""
    # Show data files
    if ls "$BOT_DIR"/data/kxbtc15m-*.jsonl 1>/dev/null 2>&1; then
        echo "Data files:"
        for f in "$BOT_DIR"/data/kxbtc15m-*.jsonl; do
            lines=$(wc -l < "$f" | xargs)
            size=$(du -h "$f" | cut -f1 | xargs)
            echo "  $(basename "$f")  ${lines} lines  ${size}"
        done
    fi
}

logs() {
    journalctl --user -u "$SERVICE" -f
}

# Main command dispatcher
case "${1:-}" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        restart
        ;;
    status)
        status
        ;;
    logs)
        logs
        ;;
    build)
        build
        ;;
    *)
        usage
        exit 1
        ;;
esac
